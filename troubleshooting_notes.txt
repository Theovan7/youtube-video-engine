

### üìä DETAILED INVESTIGATION RESULTS - 2025-05-30 14:45

**Airtable Data Analysis Completed** ‚úÖ

#### üéØ AFFECTED SEGMENT CONFIRMED
**Segment ID**: `recXwiLcbFPcIQxI7`
- **Content**: "Does life really start in your 50's?" (2.8 second duration)
- **Status**: `"Combining Media"` (STUCK - should be "combined")
- **Resources Available**: ‚úÖ Video, ‚úÖ Voiceover, ‚úÖ Images (4 B-roll images)
- **Last Modified**: 2025-05-29T14:16:08.000Z
- **Issue**: Has all components but combination process failed

#### üìã JOBS TABLE ANALYSIS
**Multiple Failed Attempts Discovered**:

1. **recEN6DmTmX5hT2gc** (2025-05-29T12:24:41.000Z)
   - Type: `combine`
   - Status: `failed` 
   - Error: `400 Client Error: Bad Request for url: https://no-code-architect-app-gpxhq.ondigitalocean.app/v1/ffmpeg/compose`

2. **recG9OScBwPfPYzDU** (2025-05-29T12:55:07.000Z)
   - Type: `combine`
   - Status: `failed`
   - External Job ID: `025c2adc-710c-431e-9779-a055cc1bea43` ‚úÖ **WEBHOOK RECEIVED**
   - Error: `Unknown status: None`
   - **Note**: This matches the "successful" job from troubleshooting notes that generated file but marked as failed

3. **recGUQnf3CQPjPLbZ** (2025-05-28T09:36:01.000Z)
   - Type: `combine`
   - Status: `failed`
   - Error: `404 Client Error: Not Found for url: https://no-code-architect-app-gpxhq.ondigitalocean.app/api/media/combine`

#### ‚ùå MISSING JOB CONFIRMED
**Job ID**: `recm8Ycr5coKYs62G`
- ‚ùå **NOT FOUND** in YouTube Video Engine Jobs table
- ‚ùå **NOT FOUND** in NCA system (404 from status endpoint)
- ‚úÖ **WAS ACCEPTED** by NCA API (202 ACCEPTED response)
- üö® **PROOF**: Job accepted but never processed - classic async pipeline failure

#### üîç PATTERN ANALYSIS
**Three Distinct Failure Types Identified**:
1. **API Endpoint Errors** (400 Bad Request, 404 Not Found)
2. **NCA Job Processing Failure** (Job accepted but lost)
3. **Webhook Processing Logic Issues** (Success marked as failure)

#### üö® CRITICAL FINDINGS

**1. NCA Pipeline Gap Confirmed**
- NCA accepts jobs (202) but some never enter processing queue
- No error returned to caller - appears successful
- Results in permanently stuck segments

**2. Webhook Logic Bug Confirmed** 
- Job `025c2adc-710c-431e-9779-a055cc1bea43` successfully generated file:
  `https://phi-bucket.nyc3.digitaloceanspaces.com/phi-bucket/025c2adc-710c-431e-9779-a055cc1bea43_output_0.mp4`
- But marked as `failed` with "Unknown status: None" error
- Webhook received but processing logic incorrectly handles success cases

**3. Multiple API Integration Issues**
- Wrong endpoint URLs being called (`/api/media/combine` vs `/v1/ffmpeg/compose`)  
- Bad request errors suggest payload format issues
- Inconsistent error handling across different failure types

### üéØ ROOT CAUSE SUMMARY

**Primary Issue**: **NCA Toolkit Async Processing Pipeline Failure**
- Jobs accepted but lost before processing
- No feedback mechanism when jobs disappear
- Segments stuck indefinitely in "Combining Media" status

**Secondary Issue**: **Webhook Handler Logic Bug**
- Successful NCA jobs marked as failed due to status processing error
- "Unknown status: None" suggests status parsing issue in webhook handler

**Tertiary Issue**: **API Integration Inconsistencies**
- Multiple wrong endpoint URLs
- Payload format mismatches causing 400 errors
- Need endpoint validation and error handling improvements

### üí° SOLUTION STRATEGY

**IMMEDIATE (Priority: CRITICAL)**
1. **Fix webhook handler status processing** 
   - Debug "Unknown status: None" error in `/webhooks/nca-toolkit`
   - Ensure successful jobs update segment status correctly
   - Add proper error logging for webhook processing

2. **Add NCA job validation**
   - Poll job status after 202 response to confirm job exists
   - Implement fallback when jobs are lost
   - Add timeout handling for missing webhooks

**SHORT-TERM (Priority: HIGH)**
3. **Fix API endpoint inconsistencies**
   - Standardize on correct NCA endpoints
   - Validate payload formats match current NCA API
   - Add request/response logging for debugging

4. **Implement defensive monitoring**
   - Alert on segments stuck in "Combining Media" > 10 minutes
   - Monitor job acceptance vs completion rates
   - Track webhook success/failure patterns

**LONG-TERM (Priority: MEDIUM)**
5. **Add circuit breaker for NCA failures**
6. **Implement retry logic with exponential backoff**
7. **Create comprehensive job lifecycle monitoring dashboard**

### üöÄ IMMEDIATE RECOVERY ACTION

**For Current Stuck Segment** (`recXwiLcbFPcIQxI7`):
1. Manually update segment status from "Combining Media" to "Ready"
2. Retry combination request with proper monitoring
3. Use successful webhook pattern from job `025c2adc-710c-431e-9779-a055cc1bea43` as reference

**Business Impact**: HIGH - Core media combination pipeline unreliable, segments stuck indefinitely

**Resolution Timeline**: 2-4 hours for critical fixes, 1-2 days for complete solution

---

### üìä WEBHOOK ERROR INVESTIGATION - 2025-06-05 11:45

**Job ID**: recUtduQk3YxVfp65
**Operation**: image_zoom
**Error Time**: 2025-06-05 11:31am

#### üéØ ERROR IDENTIFIED: Airtable Status Field Update Issue

**Error Details**:
- Type: `INVALID_MULTIPLE_CHOICE_OPTIONS`
- Message: `Insufficient permissions to create new select option ""processed""`
- API Response: 422 Unprocessable Entity

#### üîç ROOT CAUSE ANALYSIS

**Primary Issue**: Status Value Mismatch
- Webhook attempts to set status to `'processed'`
- But this is NOT a valid status in the config constants
- Valid statuses are: `pending`, `processing`, `completed`, `failed`

**Location**: `/api/webhooks.py` line ~258
```python
airtable_job_updates = {'Status': 'processed', 'Error Message': None}
```

**Secondary Issue**: Potential JSON Double-Encoding
- Error shows double quotes around "processed" 
- Suggests the status value might be getting JSON-encoded twice
- This turns `'processed'` into `'"processed"'` when sent to Airtable

#### üö® CRITICAL FINDINGS

1. **Wrong Status Value**: The webhook handler uses `'processed'` which is not a defined status constant
2. **Should Use**: `config.STATUS_COMPLETED` (which equals `'completed'`)
3. **Airtable Interpretation**: Sees `"processed"` as a new option to create, not an existing option

#### üí° SOLUTION

**IMMEDIATE FIX**: ‚úÖ **FIXED ON 2025-06-05**
Change line in `nca_toolkit_webhook` function:
```python
# FROM:
airtable_job_updates = {'Status': 'processed', 'Error Message': None}

# TO:
airtable_job_updates = {'Status': config.STATUS_COMPLETED, 'Error Message': None}
```

**Fix Applied**: Line 290 in `/api/webhooks.py` has been updated to use `config.STATUS_COMPLETED`

**ADDITIONAL CHECKS**:
1. Verify no JSON encoding is happening in `update_job()` method
2. Check all hardcoded status values match config constants
3. Ensure Airtable Jobs table has all required status options

#### üìã AFFECTED CODE PATTERNS

Search for all instances of hardcoded status values:
- `'processed'` ‚Üí Should be `config.STATUS_COMPLETED`
- `'pending'` ‚Üí Should be `config.STATUS_PENDING`
- `'processing'` ‚Üí Should be `config.STATUS_PROCESSING`
- `'failed'` ‚Üí Should be `config.STATUS_FAILED`

**Business Impact**: HIGH - All successful NCA webhook callbacks fail to update job status

---

---

### üö® IMAGE_ZOOM WEBHOOK PROCESSING FAILURE - 2025-06-05 12:05 AWST

**Job ID**: `recOK6focLg8kSwmq`
**Operation**: `image_zoom`
**Target Segment**: `recxGRBRi1Qe9sLDn`
**External NCA Job ID**: `c24eb0c9-3479-4236-b0f9-81d774141e92`

#### üéØ ERROR IDENTIFIED: Webhook URL Parameter Extraction Failure

**Error Message**: "'target_id' (segment_id) not available for successful image_zoom operation."

#### üîç ROOT CAUSE ANALYSIS

**Primary Issue**: **Webhook Request.args Parsing Failure**
- NCA job completed successfully (External Job ID: `c24eb0c9-3479-4236-b0f9-81d774141e92`)
- Webhook URL correctly constructed: `https://youtube-video-engine.fly.dev/webhooks/nca-toolkit?job_id=recOK6focLg8kSwmq&operation=image_zoom&target_id=recxGRBRi1Qe9sLDn`
- Target segment exists and has all required assets: ‚úÖ Images (4), ‚úÖ Voiceover, ‚úÖ Voiceover+Video
- But webhook handler `request.args.get('target_id')` returns `None`

**Code Location**: `/api/webhooks.py` line ~335-340
```python
elif operation == 'image_zoom':
    segment_id_for_zoom = target_id # target_id = request.args.get('target_id') from line ~129
    if not segment_id_for_zoom:
        err_msg_zoom = "'target_id' (segment_id) not available for successful image_zoom operation."
```

**Secondary Issue**: **Job Status Inconsistency**
- NCA reports job as completed successfully
- Airtable Job status shows "completed"
- But segment status remains "Generating Video" instead of "Video Ready"
- No output URL processed due to primary issue

#### üß™ EVIDENCE COLLECTED

**‚úÖ NCA Job Verification**:
- External Job ID: `c24eb0c9-3479-4236-b0f9-81d774141e92` ‚úÖ EXISTS
- Job Status: `completed` ‚úÖ SUCCESS
- Expected Output URL: `https://phi-bucket.nyc3.digitaloceanspaces.com/phi-bucket/c24eb0c9-3479-4236-b0f9-81d774141e92_output_0.mp4`

**‚úÖ Segment Data Verification** (`recxGRBRi1Qe9sLDn`):
- Status: "Generating Video" (SHOULD BE: "Video Ready")
- Video Style: "Zoom" ‚úÖ CORRECT
- Duration: 3 seconds ‚úÖ VALID
- Assets: 4 images, voiceover, combined video ‚úÖ COMPLETE
- Last Modified: 2025-06-05T04:05:07.000Z

**‚úÖ Webhook URL Construction** (from `/api/routes_v2.py` line 963):
```python
nca_webhook_params = f"job_id={job_id}&operation=image_zoom&target_id={data['segment_id']}"
webhook_url_nca = f"{config.WEBHOOK_BASE_URL}/webhooks/nca-toolkit?{nca_webhook_params}"
```

**üö® Webhook Processing Failure**:
- URL Parameters: `?job_id=recOK6focLg8kSwmq&operation=image_zoom&target_id=recxGRBRi1Qe9sLDn`
- `request.args.get('target_id')` returns `None` ‚ùå EXTRACTION FAILED

#### üí° DEBUGGING INSIGHTS

**Potential Causes**:
1. **Request Processing Issue**: Flask request.args not properly parsing URL parameters from NCA webhook callback
2. **URL Encoding**: Target_id might be getting URL-encoded/decoded incorrectly
3. **Request Method Mismatch**: NCA might be sending POST with different parameter handling
4. **Flask Blueprint Context**: Webhook route might have request context issues

**Pattern Matching**: Similar to previous status field issues where valid data exists but extraction fails

#### üöÄ SOLUTION STRATEGY

**IMMEDIATE (Priority: CRITICAL)**
1. **Add Debug Logging to Webhook Handler**
   ```python
   # In webhooks.py line ~129, add comprehensive logging:
   logger.info(f"NCA Webhook URL: {request.url}")
   logger.info(f"Request Args: {dict(request.args)}")
   logger.info(f"Request Method: {request.method}")
   logger.info(f"Request Headers: {dict(request.headers)}")
   ```

2. **Implement Robust Parameter Extraction**
   ```python
   # Fallback extraction methods:
   target_id = (request.args.get('target_id') or 
                request.form.get('target_id') or
                request.json.get('target_id') if request.json else None)
   ```

3. **Manual Processing for Current Job**
   - Extract output URL: `https://phi-bucket.nyc3.digitaloceanspaces.com/phi-bucket/c24eb0c9-3779-4236-b0f9-81d774141e92_output_0.mp4`
   - Update segment `recxGRBRi1Qe9sLDn` status to "Video Ready"
   - Update segment with Generated Video URL

**SHORT-TERM (Priority: HIGH)**
4. **Fix Webhook Parameter Parsing**
   - Investigate Flask request handling for NCA webhook format
   - Test with various parameter extraction methods
   - Add parameter validation and fallback mechanisms

5. **Add Webhook Processing Monitoring**
   - Alert on parameter extraction failures
   - Track webhook success/failure rates by operation type
   - Monitor URL parameter patterns

**LONG-TERM (Priority: MEDIUM)**
6. **Implement Webhook Processing Circuit Breaker**
7. **Add Comprehensive Request Debugging Tools**
8. **Create Webhook Processing Health Dashboard**

#### üìä BUSINESS IMPACT

**Severity**: **HIGH** - Video generation pipeline broken for image_zoom operations
**Affected Operations**: All segments with "Video Style: Zoom" fail to complete
**Data Integrity**: NCA jobs succeed but segments stuck in "Generating Video"
**User Experience**: Videos appear incomplete despite successful processing

#### üîß IMMEDIATE RECOVERY ACTION

**For Current Stuck Segment**:
1. Manually update segment `recxGRBRi1Qe9sLDn`:
   ```python
   airtable.update_segment('recxGRBRi1Qe9sLDn', {
       'Status': 'Video Ready',
       'Generated Video': 'https://phi-bucket.nyc3.digitaloceanspaces.com/phi-bucket/c24eb0c9-3479-4236-b0f9-81d774141e92_output_0.mp4'
   })
   ```

**Resolution Timeline**: 2-4 hours for critical fix, webhook parameter debugging required

**Next Steps**: 
1. Debug webhook request.args parsing issue
2. Test parameter extraction with live NCA webhook
3. Implement robust fallback parameter extraction
4. Add comprehensive webhook request logging

---